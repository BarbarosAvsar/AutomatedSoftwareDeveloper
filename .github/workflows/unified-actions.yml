name: Unified Actions

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "newsfragments/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: unified-actions-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  unified_action:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt
      - name: Run unified sequential action
        id: unified_runner
        run: |
          set +e
          python scripts/ci/run_unified_action.py \
            --events-path ci-unified-events.jsonl \
            --summary-path ci-unified-summary.md \
            --failed-jobs-path failed-jobs.json \
            --ledger-path .autosd/ci/failure_ledger.jsonl \
            --verify-report-path verify_factory_report.json \
            --conformance-report-path conformance/report.json
          exit_code=$?
          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"
          exit 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      - name: Upload unified CI artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: unified-ci-artifacts
          path: |
            ci-unified-events.jsonl
            ci-unified-summary.md
            failed-jobs.json
            .autosd/ci/failure_ledger.jsonl
            verify_factory_report.json
            conformance/report.json
          if-no-files-found: ignore
      - name: Fail workflow when blocking stages failed
        run: |
          if [ "${{ steps.unified_runner.outputs.exit_code }}" != "0" ]; then
            echo "Unified sequential action failed with exit code ${{ steps.unified_runner.outputs.exit_code }}."
            exit 1
          fi
          echo "Unified sequential action passed."
