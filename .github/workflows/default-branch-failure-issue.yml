name: Default Branch Failure Tracker

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  open-tracking-issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' && (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master') }}
    runs-on: ubuntu-latest
    steps:
      - name: Open/update tracking issue
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const title = 'Default branch CI failing';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.payload.workflow_run.id}`;
            const body = `CI failed on default branch.\n\nWorkflow: ${context.payload.workflow_run.name}\nRun: ${runUrl}\nHead SHA: ${context.payload.workflow_run.head_sha}`;
            const issues = await github.rest.issues.listForRepo({owner: context.repo.owner, repo: context.repo.repo, state: 'open'});
            const existing = issues.data.find((issue) => issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number, body});
            } else {
              await github.rest.issues.create({owner: context.repo.owner, repo: context.repo.repo, title, body, labels: ['ci']});
            }
