name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"
      - run: |
          python -m pip install -U pip
          python -m pip install -e .[dev,security]
          python -m pip install build cyclonedx-bom
      - name: Final gates
        run: |
          python -m ruff check .
          python -m ruff format --check .
          python -m mypy automated_software_developer
          python -m pytest
      - name: Build wheel and sdist
        run: python -m build
      - name: Generate SBOM
        run: |
          mkdir -p dist
          cyclonedx-py environment --output-format json --output-file dist/sbom.cdx.json
      - name: Attest build provenance
        uses: actions/attest-build-provenance@92c65d2898f1f53cfdc910b962cecff86e7f8fcc
        with:
          subject-path: dist/*
      - name: Upload release assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          files: |
            dist/*
      - name: Publish to PyPI
        if: ${{ env.PYPI_API_TOKEN != '' }}
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        uses: pypa/gh-action-pypi-publish@81e9d935c883d0b210363ab89cf05f3894778450
