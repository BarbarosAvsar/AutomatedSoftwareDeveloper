name: CI

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "newsfragments/**"
  pull_request:
    branches: [main, master]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      profile:
        description: "CI profile"
        required: true
        default: fast
        type: choice
        options:
          - fast
          - full
          - security-only
          - release-candidate

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_FAST: "3.12"

jobs:
  workflow_lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_FAST }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,security]
      - name: Workflow lint
        run: python -m automated_software_developer.cli ci lint-workflows

  fast_checks:
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.profile == 'fast') }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: workflow_lint
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_FAST }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,security]
          python -m pip install pytest-repeat pytest-xdist pyright vulture
      - name: Ruff lint
        run: python -m ruff check .
      - name: Ruff format check
        run: python -m ruff format --check .
      - name: Type check (mypy)
        run: python -m mypy automated_software_developer
      - name: Type check (pyright, non-blocking baseline)
        continue-on-error: true
        run: pyright automated_software_developer
      - name: Import cycle check
        run: python scripts/detect_import_cycles.py
      - name: Dead code analysis (informational)
        run: |
          mkdir -p artifacts
          vulture automated_software_developer --min-confidence 90 --sort-by-size > artifacts/vulture-report.txt || true
      - name: Upload dead code report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: vulture-fast
          path: artifacts/vulture-report.txt

  test_shard:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.profile != 'security-only' }}
    needs: workflow_lint
    strategy:
      fail-fast: false
      matrix:
        shard_index: [0, 1, 2]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_FAST }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,security]
      - name: Run shard tests with coverage
        run: |
          mkdir -p artifacts
          SHARD_FILES=$(python scripts/select_test_shard.py ${{ matrix.shard_index }} 3)
          python -m pytest --cov=automated_software_developer --cov-report=xml:artifacts/coverage-${{ matrix.shard_index }}.xml --junitxml=artifacts/junit-${{ matrix.shard_index }}.xml $SHARD_FILES
      - name: Upload shard artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: test-shard-${{ matrix.shard_index }}
          path: artifacts/
      - name: Upload shard diagnostics on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: shard-diagnostics-${{ matrix.shard_index }}
          path: |
            .pytest_cache
            artifacts

  coverage_guard:
    if: ${{ github.event_name == 'pull_request' }}
    needs: test_shard
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_FAST }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,security]
      - name: Compare coverage with base branch
        run: python scripts/check_coverage_diff.py "${{ github.base_ref }}"

  full_matrix_checks:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.profile == 'full') || (github.event_name == 'workflow_dispatch' && inputs.profile == 'release-candidate') }}
    needs: workflow_lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11", "3.12", "3.13"]
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.python-version == '3.13' }}
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,security]
      - name: Full checks
        run: |
          python -m ruff check .
          python -m ruff format --check .
          python -m mypy automated_software_developer
          python -m pytest

  security_linux:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.profile == 'security-only' || inputs.profile == 'full' || inputs.profile == 'release-candidate' || inputs.profile == 'fast' }}
    needs: workflow_lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_FAST }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,security]
      - name: Pip audit
        run: python -m pip_audit --progress-spinner off
      - name: Bandit SARIF
        run: |
          python -m bandit -c bandit.yaml -r automated_software_developer -f sarif -o bandit.sarif
      - name: Upload Bandit SARIF
        uses: github/codeql-action/upload-sarif@33119e582d3ab4ed79c2610af108cb08ff983917
        with:
          sarif_file: bandit.sarif
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cli_smoke:
    needs: workflow_lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_FAST }}
      - run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]
      - name: CLI smoke checks
        run: python -m pytest tests/test_cli_smoke.py -q

  coverage_report:
    if: ${{ github.event_name == 'pull_request' }}
    needs: test_shard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          pattern: test-shard-*
          path: artifacts
      - name: Coverage summary
        id: cov
        run: |
          python - <<'PY'
          from pathlib import Path
          import xml.etree.ElementTree as ET
          rates = []
          for xml in Path('artifacts').rglob('coverage-*.xml'):
              root = ET.parse(xml).getroot()
              rates.append(float(root.attrib.get('line-rate', '0')) * 100.0)
          avg = sum(rates)/len(rates) if rates else 0.0
          print(f"average_coverage={avg:.2f}")
          with open('summary.txt','w',encoding='utf-8') as fh:
              fh.write(f"Average shard coverage: {avg:.2f}%\n")
          with open(Path.cwd() / '.github_step_summary_tmp','w',encoding='utf-8') as fh:
              fh.write(f"## Coverage\n- Average shard coverage: **{avg:.2f}%**\n")
          PY
          cat .github_step_summary_tmp >> "$GITHUB_STEP_SUMMARY"
          echo "value=$(cat summary.txt)" >> "$GITHUB_OUTPUT"
      - name: Upload coverage summaries
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coverage-summary
          path: |
            artifacts
            summary.txt
      - name: Comment coverage on PR
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const body = `CI coverage summary: ${{ steps.cov.outputs.value }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  aggregate_required:
    if: ${{ always() }}
    needs:
      - workflow_lint
      - fast_checks
      - test_shard
      - coverage_guard
      - coverage_report
      - security_linux
      - cli_smoke
    runs-on: ubuntu-latest
    steps:
      - name: Check required job statuses
        run: |
          python - <<'PY'
          import json
          import os
          needs = json.loads(os.environ['NEEDS'])
          allowed = {'success', 'skipped'}
          bad = {k:v['result'] for k,v in needs.items() if v['result'] not in allowed}
          if bad:
              raise SystemExit(f"Required jobs failed: {bad}")
          print('All required checks passed or skipped')
          PY
        env:
          NEEDS: ${{ toJson(needs) }}

  self_diagnosis:
    if: ${{ failure() }}
    needs: [workflow_lint, fast_checks, test_shard, security_linux]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_FAST }}
      - name: Environment diagnostics
        run: |
          uname -a
          python -V
          python -m pip -V
          python -m pip list
          git --version
